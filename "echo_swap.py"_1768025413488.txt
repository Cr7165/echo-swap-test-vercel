import requests
import time
from datetime import datetime

# Your Telegram details
TELEGRAM_TOKEN = "7959489193:AAHSl-ONntEOEWWBKEux_g51Yg4Wl0PxiVY"
CHAT_ID = "7375579725"

# Config
INTERVAL_SECONDS = 30          # check every 30 seconds
WINDOW_SIZE = 10               # last 10 prices (~5 minutes)
DIP_THRESHOLD = 3.0            # % drop to trigger alert

prices = []                    # rolling window

print("Echo Swap (Python) starting...")

def send_telegram(msg):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {
        "chat_id": CHAT_ID,
        "text": msg
    }
    try:
        response = requests.post(url, json=payload, timeout=10)
        if response.status_code == 200:
            print("Telegram alert sent")
        else:
            print(f"Telegram failed: {response.status_code} - {response.text}")
    except Exception as e:
        print(f"Telegram send error: {e}")

def fetch_sol_price():
    url = "https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd"
    try:
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        data = response.json()
        return float(data["solana"]["usd"])
    except Exception as e:
        print(f"Price fetch failed: {e}")
        return None

# Main loop
while True:
    price = fetch_sol_price()
    if price is not None:
        prices.append(price)
        if len(prices) > WINDOW_SIZE:
            prices.pop(0)

        timestamp = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
        print(f"[{timestamp}] SOL = ${price:,.2f}  (window size: {len(prices)})")

        if len(prices) == WINDOW_SIZE:
            drop_pct = ((prices[0] - price) / prices[0]) * 100
            if drop_pct >= DIP_THRESHOLD:
                msg = f"DIP DETECTED! SOL -{drop_pct:.2f}% | ${price:,.2f}"
                print(msg)
                send_telegram(msg)
    else:
        print("Waiting for next fetch...")

    time.sleep(INTERVAL_SECONDS)
